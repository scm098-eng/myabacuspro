{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 68, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/firebase-admin.ts"],"sourcesContent":["\nimport * as admin from 'firebase-admin';\n\n// This utility ensures that the Firebase Admin SDK is initialized only once\n// across all server-side requests in a serverless environment.\n\ninterface FirebaseAdmin {\n  auth: admin.auth.Auth;\n  firestore: admin.firestore.Firestore;\n  storage: admin.storage.Storage;\n}\n\nif (!admin.apps.length) {\n  try {\n    admin.initializeApp({\n      credential: admin.credential.applicationDefault(),\n      storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,\n    });\n    console.log('Firebase Admin SDK initialized successfully.');\n  } catch (error) {\n    console.error('Firebase Admin SDK initialization error:', error);\n  }\n}\n\nconst auth = admin.auth();\nconst firestore = admin.firestore();\nconst storage = admin.storage();\n\nexport function getFirebaseAdmin(): FirebaseAdmin {\n  return { auth, firestore, storage };\n}\n"],"names":[],"mappings":";;;AACA;;AAWA,IAAI,CAAC,2HAAA,CAAA,OAAU,CAAC,MAAM,EAAE;IACtB,IAAI;QACF,CAAA,GAAA,2HAAA,CAAA,gBAAmB,AAAD,EAAE;YAClB,YAAY,2HAAA,CAAA,aAAgB,CAAC,kBAAkB;YAC/C,eAAe,QAAQ,GAAG,CAAC,mCAAmC;QAChE;QACA,QAAQ,GAAG,CAAC;IACd,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,4CAA4C;IAC5D;AACF;AAEA,MAAM,OAAO,CAAA,GAAA,2HAAA,CAAA,OAAU,AAAD;AACtB,MAAM,YAAY,CAAA,GAAA,2HAAA,CAAA,YAAe,AAAD;AAChC,MAAM,UAAU,CAAA,GAAA,2HAAA,CAAA,UAAa,AAAD;AAErB,SAAS;IACd,OAAO;QAAE;QAAM;QAAW;IAAQ;AACpC","debugId":null}},
    {"offset": {"line": 220, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/app/api/create-razorpay-customer/route.ts"],"sourcesContent":["\nimport { NextResponse } from 'next/server';\nimport { getFirebaseAdmin } from '@/lib/firebase-admin';\nimport { doc, getDoc, updateDoc } from 'firebase/firestore';\n\nexport async function POST(req: Request) {\n  console.log('API_ROUTE: /api/create-razorpay-customer received a request.');\n\n  try {\n    // Parse request body with error handling\n    let userId: string, name: string, email: string;\n    \n    try {\n      const body = await req.json();\n      userId = body.userId;\n      name = body.name;\n      email = body.email;\n    } catch (parseError) {\n      console.error('API_ROUTE: Failed to parse request body:', parseError);\n      return NextResponse.json({ \n        error: 'Invalid request body. Expected JSON with userId, name, and email.' \n      }, { status: 400 });\n    }\n\n    // Validate required fields\n    if (!userId || !name || !email) {\n      console.error('API_ROUTE: Missing required fields:', { userId: !!userId, name: !!name, email: !!email });\n      return NextResponse.json({ \n        error: 'Missing required fields. Please provide userId, name, and email.' \n      }, { status: 400 });\n    }\n\n    // Validate environment variables\n    const RAZORPAY_KEY_ID = process.env.RAZORPAY_KEY_ID;\n    const RAZORPAY_KEY_SECRET = process.env.RAZORPAY_KEY_SECRET;\n\n    if (!RAZORPAY_KEY_ID || !RAZORPAY_KEY_SECRET) {\n      console.error('API_ROUTE: FATAL - Razorpay API keys are not set in environment variables.');\n      return NextResponse.json({ \n        error: 'Server configuration error. Please contact support.' \n      }, { status: 500 });\n    }\n\n    // Initialize Firebase Admin with error handling\n    let firestore;\n    try {\n      const firebaseAdmin = getFirebaseAdmin();\n      firestore = firebaseAdmin.firestore;\n    } catch (firebaseError) {\n      console.error('API_ROUTE: Failed to initialize Firebase Admin:', firebaseError);\n      return NextResponse.json({ \n        error: 'Database connection error. Please try again.' \n      }, { status: 500 });\n    }\n\n    // Check if user already has a Razorpay customer ID\n    try {\n      const userDocRef = doc(firestore, 'users', userId);\n      const userDoc = await getDoc(userDocRef);\n      \n      if (!userDoc.exists()) {\n        console.error(`API_ROUTE: User document not found for userId: ${userId}`);\n        return NextResponse.json({ \n          error: 'User not found. Please log out and log back in.' \n        }, { status: 404 });\n      }\n\n      const userData = userDoc.data();\n      if (userData.razorpayCustomerId) {\n        console.log(`API_ROUTE: User ${userId} already has customer ID: ${userData.razorpayCustomerId}`);\n        return NextResponse.json({ customerId: userData.razorpayCustomerId });\n      }\n    } catch (firestoreError) {\n      console.error('API_ROUTE: Firestore error checking existing customer:', firestoreError);\n      return NextResponse.json({ \n        error: 'Database error. Please try again.' \n      }, { status: 500 });\n    }\n\n    console.log(`API_ROUTE: Creating new Razorpay customer for user ${userId} (${email})`);\n\n    // Create Razorpay customer\n    let customer;\n    try {\n      const authHeader = `Basic ${Buffer.from(`${RAZORPAY_KEY_ID}:${RAZORPAY_KEY_SECRET}`).toString('base64')}`;\n      \n      const response = await fetch('https://api.razorpay.com/v1/customers', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': authHeader\n        },\n        body: JSON.stringify({\n          name: name.trim(),\n          email: email.trim().toLowerCase(),\n          fail_existing: '0', // Don't fail if customer with same email exists\n          notes: {\n            firebase_uid: userId,\n            created_from: 'abacus_app'\n          }\n        })\n      });\n\n      console.log(`API_ROUTE: Razorpay API response status: ${response.status}`);\n\n      if (!response.ok) {\n        let errorDetails;\n        try {\n          errorDetails = await response.json();\n        } catch {\n          errorDetails = { error: { description: `HTTP ${response.status}: ${response.statusText}` } };\n        }\n        \n        console.error('API_ROUTE: Razorpay API error:', {\n          status: response.status,\n          statusText: response.statusText,\n          body: errorDetails\n        });\n\n        // Handle specific Razorpay errors\n        if (response.status === 400) {\n          return NextResponse.json({ \n            error: `Invalid customer data: ${errorDetails.error?.description || 'Please check your information'}` \n          }, { status: 400 });\n        } else if (response.status === 401) {\n          return NextResponse.json({ \n            error: 'Payment service authentication failed. Please contact support.' \n          }, { status: 500 });\n        } else if (response.status >= 500) {\n          return NextResponse.json({ \n            error: 'Payment service temporarily unavailable. Please try again in a moment.' \n          }, { status: 503 });\n        } else {\n          return NextResponse.json({ \n            error: `Payment service error: ${errorDetails.error?.description || 'Unknown error'}` \n          }, { status: 502 });\n        }\n      }\n\n      customer = await response.json();\n      console.log(`API_ROUTE: Successfully created Razorpay customer ID: ${customer.id}`);\n\n    } catch (fetchError: any) {\n      console.error('API_ROUTE: Network error calling Razorpay API:', fetchError);\n      return NextResponse.json({ \n        error: 'Network error connecting to payment service. Please check your connection and try again.' \n      }, { status: 503 });\n    }\n\n    // Save customer ID to Firestore\n    try {\n      const userDocRef = doc(firestore, 'users', userId);\n      await updateDoc(userDocRef, {\n        razorpayCustomerId: customer.id,\n        razorpayCustomerCreatedAt: new Date().toISOString()\n      });\n      console.log(`API_ROUTE: Successfully updated Firestore for user ${userId} with customer ID: ${customer.id}`);\n    } catch (updateError) {\n      console.error('API_ROUTE: Failed to update Firestore with customer ID:', updateError);\n      // Customer was created successfully, but we couldn't save the ID\n      // Still return success since the customer exists\n      console.warn('API_ROUTE: Customer created but Firestore update failed. Returning customer ID anyway.');\n    }\n\n    return NextResponse.json({ \n      customerId: customer.id,\n      message: 'Customer created successfully' \n    });\n\n  } catch (unexpectedError: any) {\n    console.error('API_ROUTE: Unexpected error in create-razorpay-customer:', unexpectedError);\n    \n    // Ensure we always return valid JSON\n    return NextResponse.json({ \n      error: 'An unexpected error occurred. Please try again or contact support if the problem persists.',\n      details: process.env.NODE_ENV === 'development' ? unexpectedError.message : undefined\n    }, { status: 500 });\n  }\n}\n\n// Handle unsupported methods\nexport async function GET() {\n  return NextResponse.json({ error: 'Method not allowed' }, { status: 405 });\n}\n\nexport async function PUT() {\n  return NextResponse.json({ error: 'Method not allowed' }, { status: 405 });\n}\n\nexport async function DELETE() {\n  return NextResponse.json({ error: 'Method not allowed' }, { status: 405 });\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}