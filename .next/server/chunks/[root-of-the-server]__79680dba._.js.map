{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 172, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/firebase-admin.ts"],"sourcesContent":["\nimport * as admin from 'firebase-admin';\n\n// This utility ensures that the Firebase Admin SDK is initialized only once\n// across all server-side requests in a serverless environment.\n\ninterface FirebaseAdmin {\n  auth: admin.auth.Auth;\n  firestore: admin.firestore.Firestore;\n  storage: admin.storage.Storage;\n}\n\nif (!admin.apps.length) {\n  try {\n    admin.initializeApp({\n      credential: admin.credential.applicationDefault(),\n      storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,\n    });\n    console.log('Firebase Admin SDK initialized successfully.');\n  } catch (error) {\n    console.error('Firebase Admin SDK initialization error:', error);\n  }\n}\n\nconst auth = admin.auth();\nconst firestore = admin.firestore();\nconst storage = admin.storage();\n\nexport function getFirebaseAdmin(): FirebaseAdmin {\n  return { auth, firestore, storage };\n}\n"],"names":[],"mappings":";;;AACA;;AAWA,IAAI,CAAC,2HAAA,CAAA,OAAU,CAAC,MAAM,EAAE;IACtB,IAAI;QACF,CAAA,GAAA,2HAAA,CAAA,gBAAmB,AAAD,EAAE;YAClB,YAAY,2HAAA,CAAA,aAAgB,CAAC,kBAAkB;YAC/C,eAAe,QAAQ,GAAG,CAAC,mCAAmC;QAChE;QACA,QAAQ,GAAG,CAAC;IACd,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,4CAA4C;IAC5D;AACF;AAEA,MAAM,OAAO,CAAA,GAAA,2HAAA,CAAA,OAAU,AAAD;AACtB,MAAM,YAAY,CAAA,GAAA,2HAAA,CAAA,YAAe,AAAD;AAChC,MAAM,UAAU,CAAA,GAAA,2HAAA,CAAA,UAAa,AAAD;AAErB,SAAS;IACd,OAAO;QAAE;QAAM;QAAW;IAAQ;AACpC","debugId":null}},
    {"offset": {"line": 214, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/app/api/create-subscription/route.ts"],"sourcesContent":["\nimport { NextRequest, NextResponse } from 'next/server';\nimport Razorpay from 'razorpay';\nimport { getFirebaseAdmin } from '@/lib/firebase-admin';\nimport { doc, getDoc, setDoc, collection, query, where, getDocs, updateDoc } from 'firebase-admin/firestore';\n\nconst razorpay = new Razorpay({\n  key_id: process.env.RAZORPAY_KEY_ID!,\n  key_secret: process.env.RAZORPAY_KEY_SECRET!,\n});\n\nexport async function POST(req: NextRequest) {\n  console.log('API: Create subscription request received');\n  \n  try {\n    if (!process.env.RAZORPAY_KEY_ID || !process.env.RAZORPAY_KEY_SECRET) {\n      console.error('API: Missing Razorpay credentials');\n      return NextResponse.json({ error: 'Server configuration error' }, { status: 500 });\n    }\n\n    const body = await req.json();\n    console.log('API: Request body:', body);\n    \n    const { planId, firebase_uid, customerEmail, customerName, customerContact } = body;\n\n    if (!planId || !firebase_uid || !customerEmail) {\n      console.error('API: Missing required fields', { planId, firebase_uid, customerEmail });\n      return NextResponse.json({ \n        error: 'Missing required fields',\n        details: { planId: !!planId, firebase_uid: !!firebase_uid, customerEmail: !!customerEmail }\n      }, { status: 400 });\n    }\n\n    const { firestore } = getFirebaseAdmin();\n    const userDocRef = doc(firestore, 'users', firebase_uid);\n    const userDoc = await getDoc(userDocRef);\n\n    if (!userDoc.exists()) {\n        return NextResponse.json({ error: 'User not found.' }, { status: 404 });\n    }\n    const userData = userDoc.data();\n    let customerId = userData?.razorpayCustomerId;\n    let customer;\n\n    if (customerId) {\n        try {\n            customer = await razorpay.customers.fetch(customerId);\n            console.log('API: Found existing customer:', customer.id);\n        } catch (error) {\n            console.warn('Could not fetch existing customer, creating new one.');\n            customerId = null;\n        }\n    }\n\n    if (!customer) {\n        try {\n            customer = await razorpay.customers.create({\n                name: customerName || 'Customer',\n                email: customerEmail.toLowerCase(),\n                contact: customerContact || undefined,\n                notes: { firebase_uid: firebase_uid }\n            });\n            console.log('API: Created new customer:', customer.id);\n            customerId = customer.id;\n            await updateDoc(userDocRef, { razorpayCustomerId: customerId });\n        } catch (error: any) {\n            console.error('API: Error creating customer, checking for duplicates.', error.error);\n            if (error.error?.code === 'BAD_REQUEST_ERROR') {\n                 const customers = await razorpay.customers.all({ email: customerEmail.toLowerCase() });\n                 if (customers.items && customers.items.length > 0) {\n                     customer = customers.items[0];\n                     customerId = customer.id;\n                     console.log('API: Found duplicate customer by email:', customerId);\n                     await updateDoc(userDocRef, { razorpayCustomerId: customerId });\n                 } else {\n                    throw error;\n                 }\n            } else {\n                 throw error;\n            }\n        }\n    }\n\n    const subscriptionOptions = {\n        plan_id: planId,\n        customer_id: customerId,\n        total_count: 12,\n        quantity: 1,\n        notes: {\n          firebase_uid: firebase_uid,\n          customer_email: customerEmail,\n        },\n        customer_notify: 1,\n    };\n\n    const subscription = await razorpay.subscriptions.create(subscriptionOptions);\n\n    await updateDoc(userDocRef, { razorpaySubscriptionId: subscription.id });\n\n    return NextResponse.json({\n      success: true,\n      subscriptionId: subscription.id,\n    });\n\n  } catch (error: any) {\n    console.error('API: Create subscription error:', error);\n    return NextResponse.json({ error: error.message || 'Failed to create subscription', details: error.error || null }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}