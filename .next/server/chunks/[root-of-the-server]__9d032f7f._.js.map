{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 174, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/app/api/create-subscription/route.ts"],"sourcesContent":["\nimport { NextRequest, NextResponse } from 'next/server';\nimport Razorpay from 'razorpay';\nimport { getFirebaseAdmin } from '@/lib/firebase-admin';\nimport { doc, updateDoc } from 'firebase-admin/firestore';\n\nconst razorpay = new Razorpay({\n  key_id: process.env.RAZORPAY_KEY_ID!,\n  key_secret: process.env.RAZORPAY_KEY_SECRET!,\n});\n\nexport async function POST(req: NextRequest) {\n  console.log('API: Create subscription request received');\n  \n  try {\n    if (!process.env.RAZORPAY_KEY_ID || !process.env.RAZORPAY_KEY_SECRET) {\n      console.error('API: Missing Razorpay credentials');\n      return NextResponse.json({ error: 'Server configuration error' }, { status: 500 });\n    }\n\n    const body = await req.json();\n    console.log('API: Request body:', body);\n    \n    const { planId, firebase_uid, customerEmail, customerName, customerContact } = body;\n\n    if (!planId || !firebase_uid || !customerEmail) {\n      console.error('API: Missing required fields', { planId, firebase_uid, customerEmail });\n      return NextResponse.json({ error: 'Missing required fields' }, { status: 400 });\n    }\n\n    console.log('API: Creating/finding customer for:', customerEmail);\n\n    let customer;\n    try {\n        const customers = await razorpay.customers.search({ query: { email: customerEmail.toLowerCase() } });\n        if (customers.items && customers.items.length > 0) {\n            customer = customers.items[0];\n            console.log('API: Found existing customer:', customer.id);\n             await razorpay.customers.edit(customer.id, {\n                name: customerName || customer.name,\n                contact: customerContact || customer.contact,\n                notes: { ...customer.notes, firebase_uid: firebase_uid }\n            });\n            console.log('API: Updated existing customer.');\n        } else {\n            customer = await razorpay.customers.create({\n                name: customerName || 'Customer',\n                email: customerEmail.toLowerCase(),\n                contact: customerContact || undefined,\n                notes: { firebase_uid: firebase_uid }\n            });\n            console.log('API: Created new customer:', customer.id);\n        }\n    } catch (error: any) {\n        console.error('API: Error finding or creating customer:', error);\n        throw new Error('Failed to handle Razorpay customer.');\n    }\n    \n    if (!customer || !customer.id) {\n      throw new Error('Failed to create or find customer');\n    }\n\n    console.log('API: Creating subscription for customer:', customer.id);\n\n    const redirectUrl = new URL('/payment-success', req.url).toString();\n\n    const subscription = await razorpay.subscriptions.create({\n      plan_id: planId,\n      customer_id: customer.id,\n      quantity: 1,\n      total_count: 12,\n      notes: { firebase_uid: firebase_uid, customer_email: customerEmail },\n      notify_info: {\n        notify_phone: customerContact || '',\n        notify_email: customerEmail,\n      },\n      customer_notify: 1,\n      // The callback URL is part of the subscription link, not here.\n      // We will handle redirect from the front-end after payment success.\n    });\n\n    console.log('API: Created subscription:', subscription.id);\n\n    try {\n      const { firestore } = getFirebaseAdmin();\n      const userDocRef = doc(firestore, 'users', firebase_uid);\n      await updateDoc(userDocRef, {\n        razorpayCustomerId: customer.id,\n        subscriptionCreatedAt: new Date().toISOString(),\n      });\n      console.log('API: Updated user record with customer ID');\n    } catch (firestoreError) {\n      console.error('API: Failed to update user record:', firestoreError);\n    }\n\n    return NextResponse.json({\n      success: true,\n      subscriptionId: subscription.id,\n      customerId: customer.id,\n      status: subscription.status\n    });\n\n  } catch (error: any) {\n    console.error('API: Create subscription error:', error);\n    return NextResponse.json({ error: error.message || 'Failed to create subscription', details: error.error || null }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}